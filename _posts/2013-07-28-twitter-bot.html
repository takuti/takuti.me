---
layout: post
title: "マルコフ連鎖でTwitter Botをつくりました"
lang: ja
tags:
- Development
- Natural Language Processing
---
<p>ひとまず動けばいいや程度に作りました。 @<a href="https://twitter.com/yootakuti">yootakuti</a> がそれですよろしくおねがいします。</p>
<p>Twitter公式から自分の過去ツイート5万弱をダウンロードして、そのCSVから<a href="https://twitter.com/shuumai">しゅうまい君</a>で有名になったマルコフ連鎖（らしきこと）で文章を作ります。それを30分おきに行なって、しゃべります。</p>
<p>https://twitter.com/yootakuti/status/358134512208715776</p>
<p>我ながらおもしろい。<br />
<!--more--></p>
<h3>マルコフ連鎖 is 何</h3>
<p>なんだかついったーbot界（？）では「マルコフ連鎖」というワードばかりが一人歩きしている印象を受けますが、そもそもマルコフ連鎖ってどんなものなんでしょうか。<a href="http://ja.wikipedia.org/wiki/%E3%83%9E%E3%83%AB%E3%82%B3%E3%83%95%E9%80%A3%E9%8E%96">Wikipedia先生に聞いてみましょう。</a></p>
<blockquote><p>
マルコフ連鎖は、<strong>未来の挙動が現在の値だけで決定され、過去の挙動と無関係である</strong>（マルコフ性）。各時刻において起こる状態変化（遷移または推移）に関して、マルコフ連鎖は遷移確率が過去の状態によらず、現在の状態のみによる系列である。
</p></blockquote>
<p>ふむふむ。</p>
<p>そして一般に「マルコフ連鎖でついったーbot」と言われた時にみんながやっているのは（たぶん）下のようなこと。</p>
<p>まずはツイートひとつひとつを分かち書きする。</p>
<p><strong>私はヨーグルトが好きです。</strong><br />
を分かち書きすると<br />
<strong>私　は　ヨーグルト　が　好き　です　。</strong><br />
になる。</p>
<p>ここから1つずらしながら、3つずつの要素からなる塊を以下のようにたくさんつくる。</p>
<pre>
（はじまり）　私　は
私　は　ヨーグルト
は　ヨーグルト　が
ヨーグルト　が　好き
が　好き　です
好き　です　。
です　。　（おわり）
</pre>
<p>これを対象となるすべてのツイートに対して作ってあげる。</p>
<p>上の「私はヨーグルトが好きです。」の他にもう1つ、「ヨーグルトが嫌いだ」というフレーズに対しても同様に作れば、</p>
<pre>
（はじまり）　ヨーグルト　が
ヨーグルト　が　嫌い
が　嫌い　だ
嫌い　だ　（おわり）
</pre>
<p>となる。</p>
<p>こんな中で、3つの要素の塊をつなげていくのがマルコフ連鎖。</p>
<p>ちなみに要素3つずつで塊を作っていくのは、Wikipedia先生によるところの「3階マルコフ連鎖」にあたるという認識で大丈夫なのかな。</p>
<blockquote><p>次の状態が現在を含めた過去N個の状態履歴に依存して決まる確率過程を、<strong>N階マルコフ連鎖</strong>（もしくは、N重マルコフ連鎖、N次マルコフ連鎖）という。</p></blockquote>
<p>階数が高いほど元の文章に近づいていって、低いほどめちゃめちゃになる。</p>
<p>さて、話を戻して「私はヨーグルトが好きです。」「ヨーグルトが嫌いだ」の2つの文章からマルコフ連鎖で新しいツイートを生成してみましょう。</p>
<p>例えば最初に<br />
<strong>（はじまり）　私　は</strong><br />
を選んだとしたら、次に来るのは「は」から始まる塊だけ。<br />
上で作った塊たちの中で、「は」から始まる塊は<br />
<strong>は　ヨーグルト　が</strong><br />
だけなのでこれを選択。この時点で、「私はヨーグルトが」となる。</p>
<p>その次に来るのは、先ほどと同様に、今度は「が」から始まる塊だけ。<br />
候補は、<br />
<strong>が　好き　です<br />
が　嫌い　だ</strong><br />
の2つ。このどちらかをランダムで選ぶ。</p>
<p>上が選ばれれば「私はヨーグルトが好きです」と連鎖するし、下が選ばれれば「私はヨーグルトが嫌いだ」と連鎖して、元々の文とは真逆の意味になっちゃったりして面白い。</p>
<p>更にこれを<strong>（おわり）</strong>が来るまで繰り返していくと1つの文章が出来上がるという仕組み。元のツイートが多ければ多いほど3つずつの要素からなる塊はたくさんできて、最終的に生成される文章の幅も広がるというわけですね。</p>
<p>ここでWikipedia先生の教えに戻ると、マルコフ連鎖とは<strong>未来の挙動が現在の値だけで決定され、過去の挙動と無関係である</strong>という、マルコフ性と呼ばれる特性に依るものでした。</p>
<p>つまり、<br />
<strong>は　ヨーグルト　が</strong>の次に繋がる塊<em>（＝未来の挙動）</em>　は<br />
<strong>は　ヨーグルト　が</strong><em>（＝現在の値）</em>　だけで決定され、<br />
<strong>（はじまり）　私　は</strong><em>（＝過去の挙動）</em>　と無関係である。<br />
ということ、なのかな・・・？</p>
<p>もし過去の挙動を見ていれば、どれだけ塊がたくさんあったとしても、「私はヨーグルトが」と始まってしまったら「私はヨーグルトが好きです」しかできあがらない。過去の挙動を無視するから、既存のツイートから新しいツイートが生み出せる。</p>
<p>というわけで、「マルコフ連鎖でついったーbot」なんだなぁと僕は解釈しました。しかしこのあたり、なんだかスッキリしないのでもっと理論的な話を近いうちに勉強できればと思います。</p>
<p>ここまでで何か間違いがあれば指摘していただけると嬉しいです。</p>
<h3>実装の話</h3>
<p>実装にあたり以下を参考にさせていただきました。コード面では、リプライのツイートに含まれるID（@なんちゃら）やRT/QT以降の文章、URLを除外する部分のみ参考にさせていただき、あとは上で書いたマルコフ連鎖をそのまま強引に自力で。</p>
<p>【参考】<a href="http://d.hatena.ne.jp/tondol/20120311/1331470586">マルコフ連鎖でTwitter BOTを作る - FLYING</a></p>
<p>このほかに、CSVの読み込みに関して以下を参考にさせていただきました。確かに最強な感じある。<br />
【参考】<a href="http://melborne.github.io/2013/01/24/csv-table-method-is-awesome/">Ruby標準添付ライブラリcsvのCSV.tableメソッドが最強な件について</a></p>
<p>実際に今 @<a href="https://twitter.com/yootakuti">yootakuti</a> で動いてるものは以下より。<br />
<strong><a href="https://github.com/takuti/twitter_bot">takuti/twitter_bot</a></strong></p>
<p>改善すべき点は多々ありますがとりあえず動けばいいやーな気持ちです。徐々に改善して行く予定です。しかし予定は未定です。</p>
<p>これをさくらのVPS上でcrontabから30分に一度回してあげればオーケイ。このとき、ローカル(Mac)では問題なかったのですが、さくらVPS上だと文字コード関係で怒られるので <em>ruby</em> のオプションに <em>-Ku</em> を付けてあげます。<br />
【参考】<a href="http://horahora.cocolog-nifty.com/blog/2011/06/ruby-my-dear-1-.html">Ruby, My Dear? (1) 日本語処理でハマる: ほらかわブログ</a></p>
<h3>botたのしい</h3>
<p>http://twitter.com/takuti/status/13602515900<br />
4年も前から同じような仕組みでしゅうまい君は動いてるっていうんだから、すごいですね。</p>
<p>前々から作ってみたかったついったーbotですが、実際に作ってみるとやっぱり面白いし可愛いですね。</p>
<p>そんなわけで、 @<a href="https://twitter.com/yootakuti">yootakuti</a> よろしくおねがいします。（再）</p>
